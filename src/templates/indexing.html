{% extends "base.html" %}

{% block title %}Indexing library…{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/indexing.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="indexing-container bg-light-subtle rounded-4 shadow">
        <img src="{{ url_for('static', filename='logo.svg') }}"
             alt="Spinning mixtape"
             width="120"
             height="120"
             class="cassette-spinner">

        <h1 class="mb-3">Your music library is being indexed…</h1>
        <p class="lead text-muted mb-4">
            We are scanning your collection and reading metadata from all tracks. This only happens the first time or after major changes.
        </p>

        <div id="progress-container">
            <!-- Initial fallback content (shown before JS loads) -->
            <div class="progress" style="height: 2.2rem;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
            </div>
            <p class="mt-4">Loading indexing status…</p>
        </div>

        <div id="stats" class="stats" style="display: none;">
            <div class="stat-item">
                <div class="stat-value" id="current">0</div>
                <div>Processed</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total">0</div>
                <div>Total</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="speed">—</div>
                <div>Speed</div>
            </div>
        </div>

        <div id="eta" class="eta fw-semibold text-success" style="display: none;"></div>

        <p class="tip mt-4">
            <small>
                <i class="bi bi-info-circle"></i>
                Tip: Grab a coffee or tea – we’ll be done soon! ☕
            </small>
        </p>

        <div class="mt-4">
            <small class="text-muted" id="update-info">Updating automatically…</small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}

<script>
    const progressContainer = document.getElementById('progress-container');
    const statsElement = document.getElementById('stats');
    const etaElement = document.getElementById('eta');
    const updateInfo = document.getElementById('update-info');

    // Pre-create the progress bar structure
    let progressWrapper = null;
    let progressBarInner = null;

    function createProgressBar() {
        progressWrapper = document.createElement('div');
        progressWrapper.className = 'progress';
        progressWrapper.role = 'progressbar';
        progressWrapper.style.height = '2.2rem';

        progressBarInner = document.createElement('div');
        progressBarInner.className = 'progress-bar progress-bar-striped progress-bar-animated';
        progressBarInner.style.width = '100%';
        progressBarInner.textContent = '';

        progressWrapper.appendChild(progressBarInner);
        return progressWrapper;
    }

    function updateStatus() {
        fetch('{{ url_for("indexing_status_json") }}')
            .then(response => response.json())
            .then(data => {
                if (data.done) {
                    window.location.href = '{{ url_for("landing") }}';
                    return;
                }

                const current = data.current || 0;
                const total = data.total || 0;
                const startedAt = data.started_at ? new Date(data.started_at) : null;

                if (total === 0) {
                    // Still counting files
                    progressContainer.innerHTML = `
                        <div class="progress" style="height: 2.2rem;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                        </div>
                        <p class="mt-4">Files are being counted and scanned… This may take a while for large collections.</p>
                    `;
                    statsElement.style.display = 'none';
                    etaElement.style.display = 'none';
                    return;
                }

                // Ensure progress bar exists
                if (!progressWrapper || !progressContainer.contains(progressWrapper)) {
                    progressContainer.innerHTML = '';
                    progressWrapper = createProgressBar();
                    progressContainer.appendChild(progressWrapper);
                }

                // Update progress
                const percent = (current / total * 100).toFixed(1);
                progressBarInner.style.width = `${percent}%`;
                progressBarInner.textContent = `${percent}%`;

                // Update stats
                document.getElementById('current').textContent = current.toLocaleString();
                document.getElementById('total').textContent = total.toLocaleString();

                // Speed
                if (startedAt && current > 100) {
                    const elapsedMin = (Date.now() - startedAt) / 60000;
                    const speed = Math.round(current / elapsedMin);
                    document.getElementById('speed').textContent = `${speed.toLocaleString()} /min`;
                } else {
                    document.getElementById('speed').textContent = '—';
                }

                // Show stats and ETA
                statsElement.style.display = 'flex';
                etaElement.style.display = 'block';

                // ETA
                if (current > 50 && total > 100 && startedAt) {
                    const elapsedSec = (Date.now() - startedAt) / 1000;
                    const speedPerSec = elapsedSec > 0 ? current / elapsedSec : 0;
                    const remaining = total - current;
                    const etaSec = speedPerSec > 0 ? remaining / speedPerSec : 0;
                    const etaMin = Math.round(etaSec / 60);
                    etaElement.innerHTML = `About <strong>${etaMin} minute${etaMin !== 1 ? 's' : ''}</strong> to go`;
                } else {
                    etaElement.textContent = 'Please be patient, indexation speed is being calculated…';
                }

                updateInfo.textContent = 'Updated just now';
            })
            .catch(err => {
                console.error('Failed to fetch indexing status', err);
                updateInfo.textContent = 'Update failed – retrying…';
            });
    }

    // Initial update and polling
    updateStatus();
    setInterval(updateStatus, 5000);

    // Safety reload if stuck
    let lastCurrent = 0;
    // Inside updateStatus, after fetching data:
    if (data.current && data.current > lastCurrent) {
        lastCurrent = data.current;
        // Reset a "no progress" timer
        clearTimeout(window.noProgressTimeout);
        window.noProgressTimeout = setTimeout(() => {
            window.location.reload();
        }, 300000);  // 5 minutes no progress → reload
    }
</script>
{% endblock %}