{% extends "base.html" %}

{% block title %}{{ mixtape.title }}{% endblock %}

{% block extra_meta %}
    <!-- General description for SEO -->
    <meta name="description" content="{{ mixtape.title }} – a mixtape with {{ mixtape.tracks|length }} tracks.">

    <!-- Open Graph / Facebook / LinkedIn -->
    <meta property="og:title" content="{{ mixtape.title }}"/>
    <meta property="og:type" content="music.playlist"/>
    <meta property="og:url" content="{{ url_for('play.public_play', slug=mixtape.slug, _external=True) }}"/>
    <meta property="og:description" content="A personal mixtape with {{ mixtape.tracks|length }} tracks."/>
    <meta property="og:site_name" content="Mixtape Society"/>

    {% if mixtape.cover %}
        <meta property="og:image" content="{{ url_for('play.serve_cover', filename=mixtape.cover.split('/')[-1], _external=True) }}"/>
        <meta property="og:image:width" content="1200"/>
        <meta property="og:image:height" content="1200"/>
        <meta property="og:image:alt" content="Cover of {{ mixtape.title }}"/>
    {% else %}
        <!-- Fallback afbeelding als er geen cover is -->
        <meta property="og:image" content="{{ url_for('static', filename='image.jpg') }}"/>
    {% endif %}

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="{{ mixtape.title }}"/>
    <meta name="twitter:description" content="A personal mixtape with {{ mixtape.tracks|length }} tracks."/>
    {% if mixtape.cover %}
        <meta name="twitter:image" content="{{ url_for('play.serve_cover', filename=mixtape.cover.split('/')[-1], _external=True) }}"/>
    {% else %}
        <meta name="twitter:image" content="{{ url_for('static', filename='image.jpg') }}"/>
    {% endif %}
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/play_mixtape.css') }}">
{% endblock %}


{% block content %}
    <div class="container py-5">

        {% if not public %}
        <a href="/mixtapes" class="btn btn-outline-secondary btn-sm mb-4">
            ← Back to mixtape browser
        </a>
        {% endif %}

        <div class="row g-5">
            <!-- Cover + title -->
            <div class="col-lg-4 text-center">
                {% if mixtape.cover %}
                <img src="{{ url_for('play.serve_cover', filename=mixtape.cover.split('/')[-1]) }}"
                    class="img-fluid rounded shadow mb-4"
                    style="max-height: 400px; object-fit: cover;"
                    alt="Cover for {{ mixtape.title }}">
                {% endif %}

                <h1 class="display-6 mb-2">{{ mixtape.title }}</h1>
                <p class="text-muted small mb-3">{{ mixtape.tracks|length }} tracks</p>

                <div class="text-muted small">
                    {% if mixtape.created_at %}
                    <div><i class="bi bi-calendar-plus"></i> Created: {{ mixtape.created_at[:10] }}</div>
                    {% endif %}
                    {% if mixtape.saved_at %}
                    <div><i class="bi bi-save"></i> Last changes: {{ mixtape.saved_at[:10] }} om {{ mixtape.saved_at[11:16] }}</div>
                    {% endif %}
                </div>
                <!-- Liner Notes Section -->
                {% if mixtape.liner_notes and mixtape.liner_notes.strip() %}
                <div class="mt-5">
                    <h4 class="mb-3">
                        <button class="btn btn-link text-decoration-none p-0 border-0 fw-bold collapsed"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#linerNotesCollapse"
                                aria-expanded="false"
                                aria-controls="linerNotesCollapse"
                                style="font-size: inherit;">
                            Tape Talk
                            <i class="bi bi-chevron-down ms-2 transition-chevron"></i>
                        </button>
                    </h4>

                    <div class="collapse" id="linerNotesCollapse">
                        <div class="card card-body bg-body-tertiary border-0">
                            <div id="rendered-liner-notes" class="markdown-body"></div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if not public %}
                <a href="/mixtapes" class="btn btn-outline-secondary btn-sm mt-4">Back to mixtape browser</a>
                {% endif %}
            </div>

            <!-- Player + tracklist -->
            <div class="col-lg-8">

            <!-- Music player -->
            <div class="fixed-bottom" id="bottom-player-container" style="display:none; z-index: 1000;">
                <div class="bg-dark text-white shadow-lg border-top border-secondary" style="backdrop-filter: blur(10px);">
                    <div class="container py-2">
                        <div class="d-flex align-items-center">
                            <!-- Close button -->
                            <button id="close-bottom-player" class="btn btn-sm btn-outline-light me-3 fs-4 lh-1" style="width:40px; height:40px;">
                                ×
                            </button>

                            <!-- Current track info -->
                            <div class="me-4 flex-shrink-0">
                                <div class="fw-bold" id="bottom-now-title">–</div>
                                <div class="small opacity-75" id="bottom-now-artist-album">–</div>
                            </div>

                            <!-- Audio player controls (full width) -->
                            <audio id="main-player" controls class="flex-grow-1" style="height: 42px;"></audio>

                            <!-- Optional: Prev/Next buttons inside player (feels more premium) -->
                            <button id="prev-btn-bottom" class="btn btn-outline-light ms-3" title="Vorige">
                                <i class="bi bi-skip-backward-fill"></i>
                            </button>
                            <button id="next-btn-bottom" class="btn btn-outline-light ms-2" title="Volgende">
                                <i class="bi bi-skip-forward-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keep the big play button at the top -->
            <div class="text-center my-5">
                <div class="btn-group" role="group">
                    <button id="big-play-btn"
                            class="btn btn-lg rounded-pill px-5 py-3 shadow theme-outline-btn"
                            style="border-width: 2px; font-weight: 600;">
                        <i class="bi bi-play-fill me-2" style="font-size: 1.6rem; position:relative; top:2px;"></i>
                        Play mixtape
                    </button>
                    <button id="big-share-btn" class="btn btn-outline-info btn-lg rounded-pill px-4 py-3 shadow ms-3 copy-share-btn"
                            title="Copy public share link">
                        <i class="bi bi-share-fill me-2" style="font-size: 1.4rem;"></i>
                        Share
                    </button>
                </div>
            </div>

                <!-- Tracklist -->
                <h4 class="mb-3 text-white">Tracklist</h4>
                <div class="list-group list-group-numbered">
                    {% for t in mixtape.tracks %}
                    <li class="list-group-item track-item py-4 d-flex align-items-center"
                        data-index="{{ loop.index0 }}"
                        data-path="{{ url_for('play.stream_audio', file_path=t.path) }}"
                        data-title="{{ t.title }}"
                        data-artist="{{ t.artist }}"
                        data-album="{{ t.album|default('Onbekend album') }}">

                        <div class="flex-grow-1 pe-3">
                            <div class="fw-bold">{{ t.title }}</div>
                            <div class="small opacity-75">
                                {{ t.artist }}{% if t.album %} • {{ t.album }}{% endif %}
                            </div>
                        </div>

                        <button class="btn btn-light rounded-circle play-this-track" style="width: 40px; height: 40px;">
                            <i class="bi bi-play-fill"></i>
                        </button>
                    </li>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <!-- Share toast (public page) -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
        <div id="shareToast" class="toast align-items-center text-bg-success border-0 shadow" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check2-circle me-2"></i>
                    Public link copied to clipboard!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.3.1/dist/purify.min.js" defer></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const player = document.getElementById('main-player');
        const container = document.getElementById('bottom-player-container');
        const closeBtn = document.getElementById('close-bottom-player');
        const prevBtn = document.getElementById('prev-btn-bottom');
        const nextBtn = document.getElementById('next-btn-bottom');
        const trackItems = document.querySelectorAll('.track-item');
        const bottomTitle = document.getElementById('bottom-now-title');
        const bottomArtistAlbum = document.getElementById('bottom-now-artist-album');
        let currentIndex = -1;

        // Big play button starts playback
        document.getElementById('big-play-btn')?.addEventListener('click', () => {
            if (trackItems.length > 0 && currentIndex === -1) {
                playTrack(0);
            } else if (currentIndex >= 0) {
                player.play();
            }
        });

        function playTrack(index) {
            if (index < 0 || index >= trackItems.length) {
                player.pause();
                player.src = '';
                container.style.display = 'none';
                trackItems.forEach(t => t.classList.remove('active-track'));
                currentIndex = -1;
                return;
            }

            const track = trackItems[index];
            player.src = track.dataset.path;

            // Update bottom player info
            bottomTitle.textContent = track.dataset.title;
            bottomArtistAlbum.textContent = `${track.dataset.artist} • ${track.dataset.album}`;

            // Show player
            container.style.display = 'block';

            // Highlight active track
            trackItems.forEach(t => t.classList.remove('active-track'));
            track.classList.add('active-track');

            currentIndex = index;

            // Auto-play
            player.play().catch(e => {
                console.log("Autoplay prevented:", e);
            });
        }

        // Navigation
        prevBtn.addEventListener('click', () => playTrack(currentIndex - 1));
        nextBtn.addEventListener('click', () => playTrack(currentIndex + 1));
        player.addEventListener('ended', () => playTrack(currentIndex + 1));

        // Click track in list
        trackItems.forEach((item, i) => {
            item.addEventListener('click', () => playTrack(i));
            item.querySelector('.play-this-track')?.addEventListener('click', (e) => {
                e.stopPropagation();
                playTrack(i);
            });
        });

        // Close player
        closeBtn.addEventListener('click', () => {
            player.pause();
            container.style.display = 'none';
        });

        // Optional: Auto-start with #play
        if (window.location.hash === '#play' && trackItems.length > 0) {
            setTimeout(() => playTrack(0), 500);
        }

        // Resume playback if coming from editor with sessionStorage flag
        if (sessionStorage.getItem('startPlaybackNow') && trackItems.length > 0) {
            sessionStorage.removeItem('startPlaybackNow');
            playTrack(0);
        }
    });

    // Update play button icon when active
    function updatePlayButtons() {
        document.querySelectorAll('.play-this-track i').forEach(icon => {
            icon.classList.remove('bi-pause-fill', 'bi-play-fill');
            icon.classList.add('bi-play-fill');
        });
        if (currentIndex >= 0) {
            const activeBtn = trackItems[currentIndex].querySelector('.play-this-track i');
            if (activeBtn && !player.paused) {
                activeBtn.classList.replace('bi-play-fill', 'bi-pause-fill');
            }
        }
    }

    // Call it after playTrack and on player events
    updatePlayButtons();

    player.addEventListener('play', updatePlayButtons);
    player.addEventListener('pause', updatePlayButtons);
    </script>
    <script>
        // === Liner Notes Rendering ===
        // Track reference renderer (same logic as in the editor)
        function renderTrackReferences(text, tracks) {
            if (!tracks || tracks.length === 0) return text;

            // Range: #3-7
            text = text.replace(/#(\d+)-(\d+)/g, (match, start, end) => {
                start = parseInt(start);
                end = parseInt(end);
                if (start > end || start < 1 || end > tracks.length) return match;

                const parts = [];
                for (let i = start; i <= end; i++) {
                    const t = tracks[i - 1];
                    parts.push(`${i}. ${t.title} – ${t.artist}`);
                }
                return parts.join(" → ");
            });

            // Single: #4
            text = text.replace(/#(\d+)/g, (match, num) => {
                const i = parseInt(num);
                if (i < 1 || i > tracks.length) return match;
                const t = tracks[i - 1];
                return `**${i}. ${t.title} – ${t.artist}**`;
            });

            return text;
        }

        // Render liner notes when page loads (and when collapse is shown)
        document.addEventListener('DOMContentLoaded', function () {
            const linerNotesEl = document.getElementById('rendered-liner-notes');
            if (!linerNotesEl) return;

            const rawMarkdown = {{ mixtape.liner_notes | tojson | safe }};
            const tracks = {{ mixtape.tracks | tojson | safe }};

            function render() {
                let processed = renderTrackReferences(rawMarkdown, tracks);
                let html = marked.parse(processed);
                linerNotesEl.innerHTML = DOMPurify.sanitize(html);
            }

            render();

            // Re-render when the collapse is opened (in case tracks change – unlikely but safe)
            const collapseEl = document.getElementById('linerNotesCollapse');
            collapseEl.addEventListener('shown.bs.collapse', render);
        });

        // Optional: rotate chevron when opening/closing
        document.querySelector('[data-bs-target="#linerNotesCollapse"]')?.addEventListener('click', function () {
            const icon = this.querySelector('.transition-chevron');
            if (icon) {
                icon.classList.toggle('rotated', this.getAttribute('aria-expanded') === 'true');
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Share button functionality
            const shareBtn = document.getElementById('big-share-btn');
            const toastEl = document.getElementById('shareToast');
            if (shareBtn && toastEl) {
                const toast = new bootstrap.Toast(toastEl);

                // Construct the public URL (current page URL)
                const shareUrl = window.location.href;

                shareBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        toast.show();
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        alert('Failed to copy link. Please copy the URL manually.');
                    });
                });
            }
        });
    </script>
{% endblock %}
