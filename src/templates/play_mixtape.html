{% extends "base.html" %}
{% block title %}{{ mixtape.title }}{% endblock %}

{% block content %}
<div class="container py-5">

    {% if not public %}
    <a href="/mixtapes" class="btn btn-outline-secondary btn-sm mb-4">
        ← Back to mixtape browser
    </a>
    {% endif %}

    <div class="row g-5">
        <!-- Cover + title -->
        <div class="col-lg-4 text-center">
            {% if mixtape.cover %}
            <img src="/mixtapes/files/{{ mixtape.cover }}"
                 class="img-fluid rounded shadow mb-4"
                 style="max-height: 400px; object-fit: cover;">
            {% endif %}

            <h1 class="display-6 mb-2">{{ mixtape.title }}</h1>
            <p class="text-muted small mb-3">{{ mixtape.tracks|length }} tracks</p>

            <div class="text-muted small">
                {% if mixtape.created_at %}
                <div><i class="bi bi-calendar-plus"></i> Created: {{ mixtape.created_at[:10] }}</div>
                {% endif %}
                {% if mixtape.saved_at %}
                <div><i class="bi bi-save"></i> Last changes: {{ mixtape.saved_at[:10] }} om {{ mixtape.saved_at[11:16] }}</div>
                {% endif %}
            </div>

            {% if not public %}
            <a href="/mixtapes" class="btn btn-outline-secondary btn-sm mt-4">Back to mixtape browser</a>
            {% endif %}
        </div>

        <!-- Player + tracklist -->
        <div class="col-lg-8">

        <!-- Music player -->
        <div class="fixed-bottom" id="bottom-player-container" style="display:none; z-index: 1000;">
            <div class="bg-dark text-white shadow-lg border-top border-secondary" style="backdrop-filter: blur(10px);">
                <div class="container py-2">
                    <div class="d-flex align-items-center">
                        <!-- Close button -->
                        <button id="close-bottom-player" class="btn btn-sm btn-outline-light me-3 fs-4 lh-1" style="width:40px; height:40px;">
                            ×
                        </button>

                        <!-- Current track info -->
                        <div class="me-4 flex-shrink-0">
                            <div class="fw-bold" id="bottom-now-title">–</div>
                            <div class="small opacity-75" id="bottom-now-artist-album">–</div>
                        </div>

                        <!-- Audio player controls (full width) -->
                        <audio id="main-player" controls class="flex-grow-1" style="height: 42px;"></audio>

                        <!-- Optional: Prev/Next buttons inside player (feels more premium) -->
                        <button id="prev-btn-bottom" class="btn btn-outline-light ms-3" title="Vorige">
                            <i class="bi bi-skip-backward-fill"></i>
                        </button>
                        <button id="next-btn-bottom" class="btn btn-outline-light ms-2" title="Volgende">
                            <i class="bi bi-skip-forward-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Keep the big play button at the top -->
        <div class="text-center my-5">
            <button id="big-play-btn" class="btn btn-outline-light btn-lg rounded-pill px-5 py-3 shadow subtle-play-btn">
                <i class="bi bi-play-fill me-2" style="font-size: 1.6rem; position:relative; top:2px;"></i>
                Play mixtape
            </button>
        </div>
            <!-- Tracklist -->
            <h4 class="mb-3 text-white">Tracklist</h4>
            <div class="list-group list-group-numbered">
                {% for t in mixtape.tracks %}
                <li class="list-group-item track-item py-4 d-flex align-items-center"
                     data-index="{{ loop.index0 }}"
                     data-path="{{ url_for('play.stream_audio', file_path=t.path) }}"
                     data-title="{{ t.title }}"
                     data-artist="{{ t.artist }}"
                     data-album="{{ t.album|default('Onbekend album') }}">

                    <div class="flex-grow-1 pe-3">
                        <div class="fw-bold">{{ t.title }}</div>
                        <div class="small opacity-75">
                            {{ t.artist }}{% if t.album %} • {{ t.album }}{% endif %}
                        </div>
                    </div>

                    <button class="btn btn-light rounded-circle play-this-track" style="width: 40px; height: 40px;">
                        <i class="bi bi-play-fill"></i>
                    </button>
                </li>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const player = document.getElementById('main-player');
    const container = document.getElementById('bottom-player-container');
    const closeBtn = document.getElementById('close-bottom-player');
    const prevBtn = document.getElementById('prev-btn-bottom');
    const nextBtn = document.getElementById('next-btn-bottom');
    const trackItems = document.querySelectorAll('.track-item');
    const bottomTitle = document.getElementById('bottom-now-title');
    const bottomArtistAlbum = document.getElementById('bottom-now-artist-album');
    let currentIndex = -1;

    // Big play button starts playback
    document.getElementById('big-play-btn')?.addEventListener('click', () => {
        if (trackItems.length > 0 && currentIndex === -1) {
            playTrack(0);
        } else if (currentIndex >= 0) {
            player.play();
        }
    });

    function playTrack(index) {
        if (index < 0 || index >= trackItems.length) {
            player.pause();
            player.src = '';
            container.style.display = 'none';
            trackItems.forEach(t => t.classList.remove('active-track'));
            currentIndex = -1;
            return;
        }

        const track = trackItems[index];
        player.src = track.dataset.path;

        // Update bottom player info
        bottomTitle.textContent = track.dataset.title;
        bottomArtistAlbum.textContent = `${track.dataset.artist} • ${track.dataset.album}`;

        // Show player
        container.style.display = 'block';

        // Highlight active track
        trackItems.forEach(t => t.classList.remove('active-track'));
        track.classList.add('active-track');

        currentIndex = index;

        // Auto-play
        player.play().catch(e => {
            console.log("Autoplay prevented:", e);
        });
    }

    // Navigation
    prevBtn.addEventListener('click', () => playTrack(currentIndex - 1));
    nextBtn.addEventListener('click', () => playTrack(currentIndex + 1));
    player.addEventListener('ended', () => playTrack(currentIndex + 1));

    // Click track in list
    trackItems.forEach((item, i) => {
        item.addEventListener('click', () => playTrack(i));
        item.querySelector('.play-this-track')?.addEventListener('click', (e) => {
            e.stopPropagation();
            playTrack(i);
        });
    });

    // Close player
    closeBtn.addEventListener('click', () => {
        player.pause();
        container.style.display = 'none';
    });

    // Optional: Auto-start with #play
    if (window.location.hash === '#play' && trackItems.length > 0) {
        setTimeout(() => playTrack(0), 500);
    }

    // Resume playback if coming from editor with sessionStorage flag
    if (sessionStorage.getItem('startPlaybackNow') && trackItems.length > 0) {
        sessionStorage.removeItem('startPlaybackNow');
        playTrack(0);
    }
});

// Update play button icon when active
function updatePlayButtons() {
    document.querySelectorAll('.play-this-track i').forEach(icon => {
        icon.classList.remove('bi-pause-fill', 'bi-play-fill');
        icon.classList.add('bi-play-fill');
    });
    if (currentIndex >= 0) {
        const activeBtn = trackItems[currentIndex].querySelector('.play-this-track i');
        if (activeBtn && !player.paused) {
            activeBtn.classList.replace('bi-play-fill', 'bi-pause-fill');
        }
    }
}

// Call it after playTrack and on player events
// Add inside playTrack() after player.play():
updatePlayButtons();

// Also add:
player.addEventListener('play', updatePlayButtons);
player.addEventListener('pause', updatePlayButtons);
</script>

<style>
    body {
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
    }

    /* Player balk */
    #main-player { background: var(--bs-body-bg); }
    #main-player::-webkit-media-controls-panel { background-color: var(--bs-body-bg); }
    /* Make track info truncate with ellipsis on overflow */
    #bottom-now-title,
    #bottom-now-artist-album {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Limit the width of the track info section so it doesn't push controls off-screen */
    .me-4.flex-shrink-0 {
        min-width: 0;           /* Allows flex item to shrink below content size */
        max-width: 50vw;        /* On very small screens, limit to ~half viewport */
        flex: 1 1 150px;        /* Flexible growth/shrink, with a reasonable base */
    }

    /* Ensure the entire bottom player row doesn't overflow horizontally */
    #bottom-player-container .d-flex {
        min-width: 0;           /* Prevents flex container overflow issues */
    }

    /* Optional: Smaller font on mobile for better fit */
    @media (max-width: 576px) {
        #bottom-now-title {
            font-size: 0.9rem;
        }
        #bottom-now-artist-album {
            font-size: 0.75rem;
        }
    }

    /* Track items */
    .list-group-numbered {
        counter-reset: track-counter;
        padding-left: 0; /* Remove Bootstrap's default padding */
        list-style: none; /* Ensure no fallback numbers */
    }

    .list-group-numbered .list-group-item {
        position: relative;
        padding: 1rem 1rem 1rem 3.5rem !important; /* Left padding for number + content */
        border: none;
        background-color: var(--bs-tertiary-bg);
        border-bottom: 1px solid var(--bs-border-color);
    }

    .list-group-numbered .list-group-item::before {
        content: counter(track-counter) ".";
        counter-increment: track-counter;
        position: absolute;
        left: 1.2rem;
        top: 50%;
        transform: translateY(-50%);
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--bs-secondary-color);
        width: 2rem;
        text-align: right;
    }

    /* Hover state */
    .track-item:hover {
        background-color: var(--bs-secondary-bg) !important;
    }

    /* Active (now playing) track - better color */
    .track-item.active-track {
        background: var(--bs-primary-bg-subtle) !important;
        color: var(--bs-primary-text-emphasis) !important;
    }

    .track-item.active-track .opacity-75 {
        opacity: 0.9 !important;
        color: var(--bs-secondary-color) !important;
    }

    /* Optional: make first track rounded top, last rounded bottom */
    .list-group-numbered .list-group-item:first-child {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }

    .list-group-numbered .list-group-item:last-child {
        border-bottom-left-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
        border-bottom: none;
    }

    .play-this-track {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Bottom player background - match body but with slight translucency */
    #bottom-player-container .bg-dark {
        background-color: rgba(var(--bs-body-bg-rgb), 0.95) !important;
        backdrop-filter: blur(10px);
    }

    /* Fix for light mode: ensure text is readable */
    h4.text-white {
        color: var(--bs-heading-color) !important;
    }

    /* Big play button - use Bootstrap outline variant */
    .subtle-play-btn {
        border-color: var(--bs-border-color);
    }
</style>
{% endblock %}