{% extends "base.html" %}
{% block title %}Mixtapes{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/browse_mixtapes.css') }}">
    <style>
        /* NEW: Collection badge styles */
        .collection-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
        }
        
        .collection-badge.collection-main { background-color: #0d6efd; color: white; }
        .collection-badge.collection-jazz { background-color: #6f42c1; color: white; }
        .collection-badge.collection-classical { background-color: #d63384; color: white; }
        .collection-badge.collection-default { background-color: #6c757d; color: white; }
        
        .collection-filter-bar {
            margin-bottom: 1rem;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container py-3 py-md-5">
    <div class="d-flex justify-content-between align-items-center mb-3 mb-md-4">
        <h1 class="display-6 fw-bold mb-0">My Mixtapes</h1>
        <button type="button" class="btn btn-success btn-sm btn-md-lg shadow" onclick="window.location.href='/editor'">
            <i class="bi bi-plus-circle-fill"></i> <span class="d-none d-sm-inline">New</span>
        </button>
    </div>

    <!-- NEW: Collection Filter Bar (only show if multiple collections) -->
    {% if has_multiple_collections %}
    <div class="card mb-3 shadow-sm collection-filter-bar">
        <div class="card-body p-2 p-md-3">
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="text-muted small me-2">
                    <i class="bi bi-collection"></i> Collection:
                </span>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="collectionFilter" 
                           id="filter-all" value="" autocomplete="off"
                           {% if not collection_filter %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="filter-all">
                        All ({{ mixtapes|length }})
                    </label>
                    
                    {% for collection in collections %}
                    <input type="radio" class="btn-check" name="collectionFilter" 
                           id="filter-{{ collection.id }}" 
                           value="{{ collection.id }}" 
                           autocomplete="off"
                           {% if collection_filter == collection.id %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="filter-{{ collection.id }}">
                        {{ collection.name }} ({{ collection.mixtape_count }})
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Search & Sort Bar -->
    <div class="card mb-3 shadow-sm">
        <div class="card-body p-2 p-md-3">
            <!-- Main Controls Row -->
            <div class="row g-2 align-items-center">
                <!-- Search Input Group -->
                <div class="col-lg col-md-7 col-12">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" 
                               id="searchInput" 
                               class="form-control form-control-sm" 
                               placeholder="Search..."
                               value="{{ search_query }}"
                               autocomplete="off">
                        <button class="btn btn-outline-secondary btn-sm" 
                                type="button" 
                                id="clearSearch"
                                style="display: {{ 'block' if search_query else 'none' }};">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Deep Search Button -->
                <div class="col-lg-auto col-md-auto col-6">
                    <span class="d-inline-block w-100" 
                          data-bs-toggle="tooltip" 
                          data-bs-placement="top" 
                          data-bs-title="Search within song names, artists, and albums"
                          tabindex="0">
                        <button id="deepSearchBtn" 
                                class="btn btn-primary btn-sm w-100"
                                {% if not search_query %}disabled{% endif %}>
                            <i class="bi bi-music-note-list"></i>
                            <span class="d-none d-lg-inline"> Tracks</span>
                        </button>
                    </span>
                </div>

                <!-- Sort Dropdown -->
                <div class="col-lg-auto col-md-auto col-6">
                    <select id="sortByWithOrder" class="form-select form-select-sm">
                        <optgroup label="Date">
                            <option value="updated_at:desc" {% if sort_by == 'updated_at' and sort_order == 'desc' %}selected{% endif %}>ðŸ“… Recent First</option>
                            <option value="updated_at:asc" {% if sort_by == 'updated_at' and sort_order == 'asc' %}selected{% endif %}>ðŸ“… Oldest First</option>
                            <option value="created_at:desc" {% if sort_by == 'created_at' and sort_order == 'desc' %}selected{% endif %}>ðŸ“… Newest Created</option>
                            <option value="created_at:asc" {% if sort_by == 'created_at' and sort_order == 'asc' %}selected{% endif %}>ðŸ“… Oldest Created</option>
                        </optgroup>
                        <optgroup label="Name & Size">
                            <option value="title:asc" {% if sort_by == 'title' and sort_order == 'asc' %}selected{% endif %}>ðŸ”¤ A â†’ Z</option>
                            <option value="title:desc" {% if sort_by == 'title' and sort_order == 'desc' %}selected{% endif %}>ðŸ”¤ Z â†’ A</option>
                            <option value="track_count:desc" {% if sort_by == 'track_count' and sort_order == 'desc' %}selected{% endif %}>ðŸŽµ Most Tracks</option>
                            <option value="track_count:asc" {% if sort_by == 'track_count' and sort_order == 'asc' %}selected{% endif %}>ðŸŽµ Fewest Tracks</option>
                        </optgroup>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Search/Filter Status Alert -->
    {% if search_query or collection_filter %}
    <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
        <span>
            {% if search_query and search_deep %}
                <i class="bi bi-music-note-list"></i> Deep search results for: <strong>"{{ search_query }}"</strong> 
                ({{ mixtapes|length }} mixtape{{ 's' if mixtapes|length != 1 else '' }} found in tracks/artists/albums)
            {% elif search_query %}
                <i class="bi bi-funnel"></i> Showing mixtapes with titles matching: <strong>"{{ search_query }}"</strong>
                ({{ mixtapes|length }} result{{ 's' if mixtapes|length != 1 else '' }})
            {% endif %}
            {% if collection_filter %}
                {% for c in collections if c.id == collection_filter %}
                    <br><i class="bi bi-collection"></i> Filtered to: <strong>{{ c.name }}</strong> collection
                {% endfor %}
            {% endif %}
        </span>
        <button class="btn btn-sm btn-outline-secondary" onclick="window.location.href='/mixtapes'">
            Clear Filters
        </button>
    </div>
    {% endif %}

    <!-- Mixtape Grid -->
    {% if mixtapes %}
        {% for m in mixtapes %}
        <div class="mixtape-item" data-collection-id="{{ m.collection_id }}">
            <!-- Cover -->
            {% if m.cover %}
                <img src="/mixtapes/files/{{ m.cover }}" class="mixtape-cover" alt="{{ m.title }}">
            {% else %}
                <div class="mixtape-cover d-flex align-items-center justify-content-center bg-dark">
                    <i class="bi bi-music-note-beamed text-white" style="font-size: 3rem; opacity: 0.3;"></i>
                </div>
            {% endif %}

            <!-- Info -->
            <div class="mixtape-info">
                <h3 class="mixtape-title">{{ m.title }}</h3>
                <p class="mixtape-meta">
                    <!-- NEW: Collection Badge (only show if multiple collections) -->
                    {% if has_multiple_collections %}
                    <span class="collection-badge collection-{{ m.collection_id }}" 
                          data-bs-toggle="tooltip"
                          title="From {{ m.collection_name }} collection">
                        <i class="bi bi-collection"></i> {{ m.collection_name }}
                    </span>
                    {% endif %}
                    
                    <span class="badge bg-secondary">{{ m.tracks|length }} tracks</span>
                    
                    {% if m.updated_at %}
                        <br><small class="text-muted">Modified {{ m.updated_at[:10] }} at {{ m.updated_at[11:16] }}</small>
                    {% endif %}
                </p>
            </div>

            <!-- Actions -->
            <div class="action-buttons">
                <a href="/editor/{{ m.slug }}" class="action-btn btn-edit" title="Edit">
                    <i class="bi bi-pencil-fill"></i>
                </a>
                <a href="{{ url_for('play.public_play', slug=m.slug) }}#play"
                class="action-btn btn-play" title="Play">
                    <i class="bi bi-play-fill"></i>
                </a>
                <button class="action-btn btn-share qr-share-btn"
                        data-slug="{{ m.slug }}"
                        title="Share with QR code">
                    <i class="bi bi-qr-code"></i>
                </button>
                <button class="action-btn btn-delete" title="Delete"
                        data-slug="{{ m.slug }}"
                        data-title="{{ m.title }}">
                    <i class="bi bi-trash-fill"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-mixtapes">
            <i class="bi bi-cassette display-1 mb-4 text-muted"></i>
            {% if search_query or collection_filter %}
                <h3>No mixtapes found</h3>
                <p class="text-muted">No mixtapes match your current filters</p>
                <button class="btn btn-primary mt-3" onclick="window.location.href='/mixtapes'">
                    <i class="bi bi-arrow-left"></i> Show All Mixtapes
                </button>
            {% else %}
                <h3>No mixtapes yet</h3>
                <p class="text-muted">Create your first mixtape to get started!</p>
                <button class="btn btn-success mt-3" onclick="window.location.href='/editor'">
                    <i class="bi bi-plus-circle-fill"></i> New Mixtape
                </button>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Modals (QR, Delete, etc.) remain unchanged -->
<!-- ... existing modal code ... -->
{% endblock %}

{% block extra_js %}
    <!-- Existing scripts -->
    <script type="module" src="{{ url_for('static', filename='js/browser/index.js') }}"></script>
    
    <!-- NEW: Collection filtering script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Collection filter buttons
            const filterButtons = document.querySelectorAll('[name="collectionFilter"]');
            
            filterButtons.forEach(button => {
                button.addEventListener('change', (e) => {
                    const collectionId = e.target.value;
                    const url = new URL(window.location);
                    
                    if (collectionId) {
                        url.searchParams.set('collection', collectionId);
                    } else {
                        url.searchParams.delete('collection');
                    }
                    
                    // Preserve other params
                    window.location.href = url.toString();
                });
            });
            
            // Initialize Bootstrap tooltips for collection badges
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
{% endblock %}
