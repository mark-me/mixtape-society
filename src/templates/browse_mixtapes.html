{% extends "base.html" %}

{% block title %}Mixtapes{% endblock %}

{% block extra_css %}
    <style>
        .hover-shadow:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.2) !important; transition: all 0.3s; }
    </style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="display-5 fw-bold text-center mb-5">Mixtape Society</h1>

    {% if mixtapes %}
    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
        {% for m in mixtapes %}
        <div class="col">
            <div class="card h-100 shadow hover-shadow">
                {% if m.cover %}
                <img src="/mixtapes/files/{{ m.cover }}" class="card-img-top" style="height: 250px; object-fit: cover;">
                {% else %}
                <div class="bg-dark d-flex align-items-center justify-content-center text-white" style="height: 250px;">
                    <i class="bi bi-music-note-beamed" style="font-size: 4rem;"></i>
                </div>
                {% endif %}

                <div class="card-body text-center">
                    <h5 class="card-title">{{ m.title }}</h5>
                    <p class="text-muted small">
                        {{ m.tracks|length }} tracks
                        {% if m.saved_at %}• {{ m.saved_at[:10] }}{% endif %}
                    </p>
                </div>

                <div class="card-footer bg-white d-flex justify-content-around border-0 pt-3">
                    <a href="/edit/{{ m.slug }}" class="btn btn-outline-primary btn-sm">
                        Bewerken
                    </a>
                    <a href="/mixtapes/play/{{ m.slug }}" class="btn btn-success btn-sm">
                        Afspelen
                    </a>
                    <button
                        class="btn btn-outline-info btn-sm copy-link"
                        data-url="{{ url_for('browse_mixtapes.play', slug=m.slug, _external=True) }}"
                        title="Link kopiëren">
                        <i class="bi bi-link-45deg"></i> Delen
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
        <i class="bi bi-cassette display-1"></i>
        <h3 class="mt-4">Nog geen mixtapes...</h3>
        <p>Maak er eerst één aan in de <a href="/">playlist maker</a></p>
    </div>
    {% endif %}
</div>
{% endblock %}

<!-- Toast container (eenmalig in base.html is genoeg) -->
<div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check2"></i> Link gekopieerd naar klembord!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const toastEl = document.getElementById('copyToast');
    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });

    document.querySelectorAll('.copy-link').forEach(button => {
        button.addEventListener('click', async function () {
            const url = this.getAttribute('data-url');

            try {
                await navigator.clipboard.writeText(url);
                toast.show();
                const normal = button.querySelector('.normal');
                const copied = button.querySelector('.copied');
                if (normal && copied) {
                    normal.classList.add('d-none');
                    copied.classList.remove('d-none');
                    setTimeout(() => {
                        normal.classList.remove('d-none');
                        copied.classList.add('d-none');
                    }, 2000);
                }
            } catch (err) {
                // Fallback voor oudere browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                toast.show();
            }
        });
    });
});
</script>