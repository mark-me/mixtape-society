<!DOCTYPE html>
<html lang="nl" data-bs-theme="auto">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      {% block title %}
        Mixtape creation
      {% endblock %}| Mixtape Society
    </title>
    <!-- Adaptive filled cassette favicon (black in light, white in dark) -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/favicon.png') }}" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!-- Bootstrap 5.3 + Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <meta name="robots" content="noindex, nofollow">
    <!-- Block for extra meta tags (social cards) -->
    {% block extra_meta %}
    {% endblock %}

    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/corruptionModals.css') }}" />
    {% block extra_css %}
    {% endblock %}
  </head>
  <body class="{% if is_authenticated %}authenticated{% endif %}">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-md navbar-dark bg-success shadow-sm sticky-top">
      <div class="container">
        <a class="navbar-brand position-relative d-flex align-items-center" href="/mixtapes" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Version v{{ app_version }}">
          <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Mixtape Society" width="47" height="30" class="me-2" />
          <span class="d-none d-sm-inline">Mixtape Society</span>
          <span class="d-inline d-sm-none">Mixtape Society</span> <!-- Possible shortening of name -->
        </a>

        <button class="navbar-toggler border-0 p-1" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
          <div class="navbar-nav ms-auto d-flex align-items-center gap-2 mt-2 mt-md-0">
            {% if is_authenticated %}
            <div>
              <button class="btn btn-outline-light d-flex align-items-center gap-2"
                      id="collectionBtn"
                      data-bs-toggle="modal"
                      data-bs-target="#collectionStatsModal"
                      title="View collection statistics">
                <i class="bi bi-music-note-list"></i>
                <span>Collection</span>
              </button>
            </div>
            {% endif %}

            <div class="dropdown">
              <button class="btn btn-outline-light dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" id="themeNavbarButton">
                <i class="bi bi-sun-fill" id="themeNavbarIcon"></i>
                <span class="d-md-none">Theme</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><button class="dropdown-item d-flex align-items-center gap-2" data-theme="light"><i class="bi bi-sun-fill"></i> Light</button></li>
                <li><button class="dropdown-item d-flex align-items-center gap-2" data-theme="dark"><i class="bi bi-moon-stars-fill"></i> Dark</button></li>
                <li><hr class="dropdown-divider" /></li>
                <li><button class="dropdown-item d-flex align-items-center gap-2 active" data-theme="auto"><i class="bi bi-circle-half"></i> System</button></li>
              </ul>
            </div>
            <div>
            {% if is_authenticated %}
              <a class="btn btn-outline-light d-flex align-items-center gap-2" href="https://mark-me.github.io/mixtape-society/user/creators/index.html" target="_blank" rel="noopener noreferrer" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Help for Mixtape creation">
            {% else %}
              <a class="btn btn-outline-light d-flex align-items-center gap-2" href="https://mark-me.github.io/mixtape-society/user/recipients/index.html" target="_blank" rel="noopener noreferrer" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Help for Mixtape listening">
            {% endif %}
                <i class="bi bi-question-circle fs-5"></i>
                <span class="d-md-none">Help</span>
              </a>
            </div>


            <div>
              <a class="btn btn-outline-light d-flex align-items-center gap-2" href="https://github.com/mark-me/mixtape-society" target="_blank" rel="noopener noreferrer" data-bs-toggle="tooltip" data-bs-placement="bottom" title="View source on GitHub">
                <i class="bi bi-github fs-5"></i>
                <span class="d-md-none">GitHub</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <main>
      {% block content %}

      {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-white-50 py-4 mt-5">
      <div class="container text-center">
        <small>{{ now.year }} â€¢ Mixtape Society</small>
      </div>
    </footer>

    <!-- ==== GLOBAL APP MODAL (used by showAlert / showConfirm) ==== -->
    <div class="modal fade" id="appModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <!-- Header â€“ title + close button -->
            <div class="modal-header">
                <h5 class="modal-title" id="appModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body â€“ filled dynamically -->
            <div class="modal-body" id="appModalBody"></div>

            <!-- Footer â€“ buttons injected dynamically -->
            <div class="modal-footer" id="appModalFooter"></div>
            </div>
        </div>
    </div>

    <!-- ==== NAVIGATION GUARD MODAL (custom "Leave page?") ==== -->
    <div class="modal fade" id="navigateAwayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

        <div class="modal-header">
            <h5 class="modal-title">Unsaved changes</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
        </div>

        <div class="modal-body">
            You have unsaved changes. Are you sure you want to leave this page?
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal" id="stayBtn">Stay</button>
            <button type="button" class="btn btn-danger"
                    id="leaveBtn">Leave</button>
        </div>

        </div>
    </div>
    </div>

    <!-- ==== COLLECTION STATS MODAL ==== -->
    <div class="modal fade" id="collectionStatsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-music-note-list me-2"></i>Collection Statistics
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Loading state -->
            <div id="statsLoading" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2 text-muted">Loading collection statistics...</p>
            </div>

            <!-- Stats content (hidden initially) -->
            <div id="statsContent" style="display: none;">
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="card text-center bg-artist-subtle border-artist">
                    <div class="card-body">
                      <i class="bi bi-person-fill fs-3 text-artist"></i>
                      <h3 class="mt-2 mb-0 text-artist" id="statsArtists">-</h3>
                      <p class="text-muted mb-0 small">Artists</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card text-center bg-album-subtle border-album">
                    <div class="card-body">
                      <i class="bi bi-disc fs-3 text-album"></i>
                      <h3 class="mt-2 mb-0 text-album" id="statsAlbums">-</h3>
                      <p class="text-muted mb-0 small">Albums</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card text-center bg-track-subtle border-track">
                    <div class="card-body">
                      <i class="bi bi-music-note fs-3 text-track"></i>
                      <h3 class="mt-2 mb-0 text-track" id="statsTracks">-</h3>
                      <p class="text-muted mb-0 small">Tracks</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-muted">
                    <i class="bi bi-clock me-1"></i>Total Duration
                  </span>
                  <strong id="statsDuration">-</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">
                    <i class="bi bi-calendar-plus me-1"></i>Last Added
                  </span>
                  <strong id="statsLastAdded">-</strong>
                </div>
              </div>

              <hr class="my-4">

              <div class="d-grid">
                <button class="btn btn-primary d-flex align-items-center justify-content-center gap-2"
                        id="resyncBtn">
                  <i class="bi bi-arrow-clockwise"></i>
                  Resync Library
                </button>
                <small class="text-muted text-center mt-2">
                  Rescans your music collection for changes
                </small>
              </div>
            </div>

            <!-- Error state (hidden initially) -->
            <div id="statsError" style="display: none;" class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <span id="statsErrorMessage">Failed to load statistics</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==== RESYNC CONFIRMATION MODAL ==== -->
    <div class="modal fade" id="resyncConfirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Resync Music Library</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>This will rescan your entire music collection and update the database with any changes.</p>
            <p class="mb-0"><strong>This process may take several minutes depending on your library size.</strong></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmResyncBtn">
              <i class="bi bi-arrow-clockwise me-1"></i> Start Resync
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==== DATABASE CORRUPTION MODAL ==== -->
    <div class="modal fade" id="corruptionModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>Database Issue Detected
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>The music library database needs to be rebuilt.</p>
            <p>This can happen after unexpected shutdowns or system crashes.</p>
            <p class="mb-0">
              <strong>Don't worry</strong> - your music files are safe.
              Only the database index needs to be recreated.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="showResetConfirmBtn">
              Reset Database
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==== DATABASE RESET CONFIRMATION MODAL ==== -->
    <div class="modal fade" id="confirmResetModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Database Reset</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>This will:</p>
            <ul>
              <li>Delete the corrupted database</li>
              <li>Scan all your music files</li>
              <li>Rebuild the database from scratch</li>
            </ul>
            <p class="mb-0">
              <strong>This may take a few minutes depending on your library size.</strong>
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmResetBtn">
              <i class="bi bi-arrow-clockwise me-1"></i>Yes, Reset Database
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==== RESET LOADING OVERLAY ==== -->
    <div id="resetLoadingOverlay">
      <div class="loading-spinner"></div>
      <p>Resetting database...</p>
    </div>

    <!-- ==== QR CODE SHARE MODAL (Global) ==== -->
    <div class="modal fade" id="qrShareModal" tabindex="-1" aria-labelledby="qrShareModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="qrShareModalLabel">
              <i class="bi bi-share me-2"></i>Share Mixtape
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <!-- Share Mode Tabs -->
            <ul class="nav nav-pills mb-3 justify-content-center" id="shareModeTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="regular-share-tab" data-bs-toggle="pill"
                        data-bs-target="#regular-share-pane" type="button" role="tab">
                  <i class="bi bi-share-fill me-1"></i> Share
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="gift-share-tab" data-bs-toggle="pill"
                        data-bs-target="#gift-share-pane" type="button" role="tab">
                  <i class="bi bi-gift-fill me-1"></i> Gift
                </button>
              </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="shareModeTabContent">

              <!-- Regular Share Tab -->
              <div class="tab-pane fade show active" id="regular-share-pane" role="tabpanel">
                <div class="text-center">
                  <!-- Loading state -->
                  <div id="qr-loading" class="py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Generating QR code...</span>
                    </div>
                    <p class="mt-3 text-muted">Generating QR code...</p>
                  </div>

                  <!-- QR Code image -->
                  <img id="qr-code-img"
                       src=""
                       alt="QR Code"
                       class="img-fluid rounded shadow-lg mb-3"
                       style="display: none; max-width: 100%; height: auto;">

                  <!-- Error state -->
                  <div id="qr-error" class="alert alert-danger" style="display: none;" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="qr-error-message">Failed to generate QR code</span>
                  </div>

                  <!-- Instructions -->
                  <div id="qr-instructions" class="mt-3 text-muted small" style="display: none;">
                    <i class="bi bi-info-circle me-1"></i>
                    Scan this code with a phone camera to play the mixtape
                  </div>
                </div>
              </div>

              <!-- Gift Share Tab -->
              <div class="tab-pane fade" id="gift-share-pane" role="tabpanel">

                <!-- Gift Configuration Form (shown when needed) -->
                <div id="gift-config-form">
                  <div class="mb-3">
                    <label for="gift-creator-name-modal" class="form-label">
                      <i class="bi bi-person-fill me-1"></i> From:
                    </label>
                    <input type="text"
                           class="form-control"
                           id="gift-creator-name-modal"
                           placeholder="Your name">
                  </div>

                  <div class="mb-3">
                    <label for="gift-receiver-name-modal" class="form-label">
                      <i class="bi bi-person-heart me-1"></i> To:
                    </label>
                    <input type="text"
                           class="form-control"
                           id="gift-receiver-name-modal"
                           placeholder="Recipient's name">
                  </div>

                  <div class="mb-3">
                    <label for="gift-note-modal" class="form-label">
                      <i class="bi bi-chat-heart-fill me-1"></i> Gift Note:
                    </label>
                    <textarea class="form-control"
                              id="gift-note-modal"
                              rows="3"
                              placeholder="Add a personal message for this gift..."></textarea>
                    <small class="form-text text-muted">
                      This will replace the mixtape description for this gift
                    </small>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">
                      <i class="bi bi-palette-fill me-1"></i> Unwrap Style:
                    </label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gift-style-modal"
                               id="style-playful-modal" value="playful" checked>
                        <label class="form-check-label" for="style-playful-modal">
                          ðŸŽ‰ Playful
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gift-style-modal"
                               id="style-elegant-modal" value="elegant">
                        <label class="form-check-label" for="style-elegant-modal">
                          âœ¨ Elegant
                        </label>
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox"
                             id="show-tracklist-modal" checked>
                      <label class="form-check-label" for="show-tracklist-modal">
                        Show full tracklist after unwrapping
                      </label>
                    </div>
                  </div>

                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox"
                             id="save-gift-defaults-modal">
                      <label class="form-check-label" for="save-gift-defaults-modal">
                        Save "From" name as default
                      </label>
                    </div>
                  </div>

                  <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="preview-gift-style">
                      <i class="bi bi-eye me-1"></i> Preview Style
                    </button>
                    <button type="button" class="btn btn-primary" id="generate-gift-qr">
                      <i class="bi bi-gift me-1"></i> Generate Gift QR
                    </button>
                  </div>
                </div>

                <!-- Gift QR Display (shown after generation) -->
                <div id="gift-qr-display" style="display: none;">
                  <div class="text-center">
                    <!-- Loading state -->
                    <div id="gift-qr-loading" class="py-4" style="display: none;">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generating gift QR code...</span>
                      </div>
                      <p class="mt-3 text-muted">Generating gift QR code...</p>
                    </div>

                    <!-- Gift QR Code image -->
                    <img id="gift-qr-code-img"
                         src=""
                         alt="Gift QR Code"
                         class="img-fluid rounded shadow-lg mb-3"
                         style="display: none; max-width: 100%; height: auto;">

                    <!-- Gift Info -->
                    <div id="gift-info" class="text-start mb-3" style="display: none;">
                      <p class="mb-1">
                        <i class="bi bi-person-fill me-2"></i><strong>From:</strong>
                        <span id="gift-from-display"></span>
                      </p>
                      <p class="mb-1">
                        <i class="bi bi-person-heart me-2"></i><strong>To:</strong>
                        <span id="gift-to-display"></span>
                      </p>
                      <p class="mb-2">
                        <i class="bi bi-palette me-2"></i><strong>Style:</strong>
                        <span id="gift-style-display"></span>
                      </p>
                      <div class="alert alert-info py-2 px-3 small">
                        <i class="bi bi-printer me-1"></i>
                        <strong>Want to print?</strong> Download includes cover art + title for gifting
                      </div>
                    </div>

                    <!-- Edit link -->
                    <div id="gift-edit-link" class="mb-3" style="display: none;">
                      <button class="btn btn-link btn-sm p-0" id="edit-gift-settings">
                        <i class="bi bi-gear me-1"></i> Edit gift settings
                      </button>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div class="modal-footer justify-content-between">
            <button type="button"
                    id="qr-copy-link-btn"
                    class="btn btn-warning">
              <i class="bi bi-link-45deg me-1"></i>
              Copy Link
            </button>

            <button type="button"
                    id="qr-download-btn"
                    class="btn btn-primary">
              <i class="bi bi-download me-1"></i>
              Download QR
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+R/ZzU4ZJ3v7q7i4c1d6j6f7u6s9iL" crossorigin="anonymous"></script>
    <script type="module" src="{{ url_for('static', filename='js/base/index.js') }}"></script>

    {% block extra_js %}
    {% endblock %}
  </body>
</html>
