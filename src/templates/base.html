<!DOCTYPE html>
<html lang="nl" data-bs-theme="auto">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      {% block title %}
        Mixtape creation
      {% endblock %}| Mixtape Society
    </title>
    <!-- Adaptive filled cassette favicon (black in light, white in dark) -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.svg') }}" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!-- Bootstrap 5.3 + Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <meta name="robots" content="noindex, nofollow">
    <!-- Block for extra meta tags (social cards) -->
    {% block extra_meta %}
    {% endblock %}

    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/corruptionModals.css') }}" />
    {% block extra_css %}
    {% endblock %}
  </head>
  <body class="{% if is_authenticated %}authenticated{% endif %}">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-md navbar-dark bg-success shadow-sm sticky-top">
      <div class="container">
        <a class="navbar-brand position-relative d-flex align-items-center" href="/mixtapes" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Version v{{ app_version }}">
          <img src="{{ url_for('static', filename='logo.svg') }}" alt="Mixtape Society" width="47" height="30" class="me-2" />
          <span class="d-none d-sm-inline">Mixtape Society</span>
          <span class="d-inline d-sm-none">Mixtape Society</span> <!-- Possible shortening of name -->
        </a>

        <button class="navbar-toggler border-0 p-1" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
          <div class="navbar-nav ms-auto d-flex align-items-center gap-2 mt-2 mt-md-0">
            {% if is_authenticated %}
            <div>
              <button class="btn btn-outline-light d-flex align-items-center gap-2"
                      id="collectionBtn"
                      data-bs-toggle="modal"
                      data-bs-target="#collectionStatsModal"
                      title="View collection statistics">
                <i class="bi bi-music-note-list"></i>
                <span>Collection</span>
              </button>
            </div>
            {% endif %}

            <div class="dropdown">
              <button class="btn btn-outline-light dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" id="themeNavbarButton">
                <i class="bi bi-sun-fill" id="themeNavbarIcon"></i>
                <span class="d-md-none">Theme</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><button class="dropdown-item d-flex align-items-center gap-2" data-theme="light"><i class="bi bi-sun-fill"></i> Light</button></li>
                <li><button class="dropdown-item d-flex align-items-center gap-2" data-theme="dark"><i class="bi bi-moon-stars-fill"></i> Dark</button></li>
                <li><hr class="dropdown-divider" /></li>
                <li><button class="dropdown-item d-flex align-items-center gap-2 active" data-theme="auto"><i class="bi bi-circle-half"></i> System</button></li>
              </ul>
            </div>

            <div>
              <a class="btn btn-outline-light d-flex align-items-center gap-2" href="https://github.com/mark-me/mixtape-society" target="_blank" rel="noopener noreferrer" data-bs-toggle="tooltip" data-bs-placement="bottom" title="View source on GitHub">
                <i class="bi bi-github fs-5"></i>
                <span class="d-md-none">GitHub</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <main>
      {% block content %}

      {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-white-50 py-4 mt-5">
      <div class="container text-center">
        <small>{{ now.year }} • Mixtape Society</small>
      </div>
    </footer>

    <!-- ==== GLOBAL APP MODAL (used by showAlert / showConfirm) ==== -->
    <div class="modal fade" id="appModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <!-- Header – title + close button -->
            <div class="modal-header">
                <h5 class="modal-title" id="appModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body – filled dynamically -->
            <div class="modal-body" id="appModalBody"></div>

            <!-- Footer – buttons injected dynamically -->
            <div class="modal-footer" id="appModalFooter"></div>
            </div>
        </div>
    </div>

    <!-- ==== NAVIGATION GUARD MODAL (custom "Leave page?") ==== -->
    <div class="modal-fade" id="navigateAwayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

        <div class="modal-header">
            <h5 class="modal-title">Unsaved changes</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
        </div>

        <div class="modal-body">
            You have unsaved changes. Are you sure you want to leave this page?
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal" id="stayBtn">Stay</button>
            <button type="button" class="btn btn-danger"
                    id="leaveBtn">Leave</button>
        </div>

        </div>
    </div>
    </div>

    <!-- ==== COLLECTION STATS MODAL ==== -->
    <div class="modal fade" id="collectionStatsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-music-note-list me-2"></i>Collection Statistics
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Loading state -->
            <div id="statsLoading" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2 text-muted">Loading collection statistics...</p>
            </div>

            <!-- Stats content (hidden initially) -->
            <div id="statsContent" style="display: none;">
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="card text-center bg-artist-subtle border-artist">
                    <div class="card-body">
                      <i class="bi bi-person-fill fs-3 text-artist"></i>
                      <h3 class="mt-2 mb-0 text-artist" id="statsArtists">-</h3>
                      <p class="text-muted mb-0 small">Artists</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card text-center bg-album-subtle border-album">
                    <div class="card-body">
                      <i class="bi bi-disc fs-3 text-album"></i>
                      <h3 class="mt-2 mb-0 text-album" id="statsAlbums">-</h3>
                      <p class="text-muted mb-0 small">Albums</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card text-center bg-track-subtle border-track">
                    <div class="card-body">
                      <i class="bi bi-music-note fs-3 text-track"></i>
                      <h3 class="mt-2 mb-0 text-track" id="statsTracks">-</h3>
                      <p class="text-muted mb-0 small">Tracks</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-muted">
                    <i class="bi bi-clock me-1"></i>Total Duration
                  </span>
                  <strong id="statsDuration">-</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">
                    <i class="bi bi-calendar-plus me-1"></i>Last Added
                  </span>
                  <strong id="statsLastAdded">-</strong>
                </div>
              </div>

              <hr class="my-4">

              <div class="d-grid">
                <button class="btn btn-primary d-flex align-items-center justify-content-center gap-2"
                        id="resyncBtn">
                  <i class="bi bi-arrow-clockwise"></i>
                  Resync Library
                </button>
                <small class="text-muted text-center mt-2">
                  Rescans your music collection for changes
                </small>
              </div>
            </div>

            <!-- Error state (hidden initially) -->
            <div id="statsError" style="display: none;" class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <span id="statsErrorMessage">Failed to load statistics</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==== RESYNC CONFIRMATION MODAL ==== -->
    <div class="modal fade" id="resyncConfirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Resync Music Library</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>This will rescan your entire music collection and update the database with any changes.</p>
            <p class="mb-0"><strong>This process may take several minutes depending on your library size.</strong></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmResyncBtn">
              <i class="bi bi-arrow-clockwise me-1"></i> Start Resync
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==== DATABASE CORRUPTION MODAL ==== -->
    <div class="modal fade" id="corruptionModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>Database Issue Detected
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>The music library database needs to be rebuilt.</p>
            <p>This can happen after unexpected shutdowns or system crashes.</p>
            <p class="mb-0">
              <strong>Don't worry</strong> - your music files are safe.
              Only the database index needs to be recreated.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="showResetConfirmBtn">
              Reset Database
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==== DATABASE RESET CONFIRMATION MODAL ==== -->
    <div class="modal fade" id="confirmResetModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Database Reset</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>This will:</p>
            <ul>
              <li>Delete the corrupted database</li>
              <li>Scan all your music files</li>
              <li>Rebuild the database from scratch</li>
            </ul>
            <p class="mb-0">
              <strong>This may take a few minutes depending on your library size.</strong>
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmResetBtn">
              <i class="bi bi-arrow-clockwise me-1"></i>Yes, Reset Database
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==== RESET LOADING OVERLAY ==== -->
    <div id="resetLoadingOverlay">
      <div class="loading-spinner"></div>
      <p>Resetting database...</p>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+R/ZzU4ZJ3v7q7i4c1d6j6f7u6s9iL" crossorigin="anonymous"></script>
    <script type="module" src="{{ url_for('static', filename='js/base/index.js') }}"></script>

    {% block extra_js %}
    {% endblock %}
  </body>
</html>
