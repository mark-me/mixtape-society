# Offline Mixtape Download Feature

## Overview
This implementation adds the ability for users to download mixtapes as offline packages with automatic FLAC→MP3 conversion.

## Architecture

### 1. New Download Blueprint (`download.py`)
- **Location**: New file, should be imported alongside other blueprints
- **Purpose**: Handles packaging mixtapes into downloadable ZIP files
- **Key Features**:
  - Server-side FLAC to MP3 conversion (320kbps)
  - Preserves ID3 metadata during conversion
  - Includes cover art and liner notes
  - Creates standalone offline player HTML

### 2. Modified Files

#### `app.py`
- Added import for `create_download_blueprint`
- Registered blueprint at `/download` prefix

#### `play_mixtape.html`
- Added "Download" button between Play and Share buttons
- Button links to `/download/<slug>/package` endpoint

#### `play_mixtape.css`
- Updated mobile styles to handle three buttons (Play, Download, Share)
- Maintains icon-only display on mobile devices

#### `offline_player.html`
- New template that gets bundled in the ZIP
- Standalone HTML player that works without server
- Uses Bootstrap CDN for styling
- Features:
  - Track listing with playback controls
  - Liner notes display
  - Cover art display
  - Bottom player bar with prev/next controls
  - Auto-play next track

## How It Works

### Download Flow
1. User clicks "Download" button on mixtape page
2. Server creates in-memory ZIP file containing:
   - `mixtape.json` - Clean metadata without server paths
   - `index.html` - Offline player interface
   - `cover.jpg/png` - Cover artwork (if available)
   - Audio files - All tracks (FLAC converted to MP3)
3. ZIP streams to user for download

### FLAC Conversion
- Uses FFmpeg for conversion
- Quality: 320kbps MP3 (high quality)
- Preserves metadata: title, artist, album
- Timeout: 5 minutes per file
- Falls back gracefully on conversion failure

### File Naming
Tracks are named: `01 - Artist - Title.mp3`
- Sanitized for filesystem safety
- Numbered for proper ordering
- Truncated to 50 chars per field

## Requirements

### System Dependencies
```bash
# FFmpeg must be installed on the server
apt-get install ffmpeg  # Debian/Ubuntu
brew install ffmpeg     # macOS
```

### Python Dependencies
Already in your codebase:
- `Flask`
- `zipfile` (stdlib)
- `subprocess` (stdlib)

## Usage

### For Users
1. Open any mixtape page (e.g., `/play/share/my-mixtape`)
2. Click the green "Download" button
3. Save the ZIP file
4. Extract and open `index.html` in a browser
5. Audio files work in any media player

### For Developers

#### Testing Conversion
```python
# Test FLAC conversion locally
from pathlib import Path
import subprocess

flac_path = Path("/path/to/file.flac")
result = subprocess.run([
    "ffmpeg", "-i", str(flac_path),
    "-codec:a", "libmp3lame", "-b:a", "320k",
    "-f", "mp3", "-"
], capture_output=True, check=True)

with open("output.mp3", "wb") as f:
    f.write(result.stdout)
```

#### Customize Conversion Quality
Edit `download.py`, line ~126:
```python
"-b:a", "320k",  # Change to "256k", "192k", etc.
```

## Integration Points

### Registration in `app.py`
```python
from routes import create_download_blueprint

app.register_blueprint(
    create_download_blueprint(mixtape_manager=mixtape_manager, logger=logger),
    url_prefix="/download",
)
```

### Template Usage
```html
<a href="{{ url_for('download.download_mixtape', slug=mixtape.slug) }}"
   class="btn btn-outline-success">
    <i class="bi bi-download"></i> Download
</a>
```

## Advantages

1. **No `MixtapeManager` Changes**: Keeps that class focused on metadata only
2. **Separation of Concerns**: Download logic isolated in its own blueprint
3. **Reusable**: Can download both public and private mixtapes
4. **Offline First**: The downloaded package works completely offline
5. **Space Efficient**: FLAC→MP3 conversion significantly reduces file size
6. **No Temporary Files**: Everything streams in-memory (efficient)

## Performance Considerations

### File Size Reduction
- FLAC files: ~30-50MB per track
- MP3 320kbps: ~7-10MB per track
- Typical 12-track mixtape: 360MB → 100MB (72% reduction)

### Processing Time
- Conversion: ~10-30 seconds per FLAC track
- ZIP creation: ~5-10 seconds for metadata/packaging
- Total: 2-6 minutes for typical mixtape (acceptable for download)

### Memory Usage
- ZIP created in-memory (efficient for small-medium mixtapes)
- For huge mixtapes (50+ tracks), consider streaming ZIP creation

## Future Enhancements

1. **Progress Indicator**: Add server-sent events to show conversion progress
2. **Quality Options**: Let users choose MP3 quality (128k/320k)
3. **Batch Downloads**: Download multiple mixtapes at once
4. **Background Jobs**: Use Celery for async conversion (for large libraries)
5. **Caching**: Cache converted MP3s to avoid re-conversion

## Troubleshooting

### FFmpeg Not Found
```
Error: FFmpeg conversion failed
Solution: Install FFmpeg on the server
```

### Conversion Timeout
```
Error: FFmpeg conversion timed out
Solution: Increase timeout in download.py (line 129)
```

### Memory Issues
```
Error: Out of memory during ZIP creation
Solution: Implement streaming ZIP creation for large mixtapes
```

## Testing Checklist

- [ ] Download button appears on mixtape page
- [ ] Button works on mobile (icon-only)
- [ ] ZIP downloads successfully
- [ ] ZIP contains all expected files
- [ ] `index.html` opens and plays tracks
- [ ] FLAC tracks are converted to MP3
- [ ] Non-FLAC tracks are included as-is
- [ ] Metadata is preserved
- [ ] Cover art displays in offline player
- [ ] Liner notes display correctly

## Security Considerations

1. **Path Traversal**: Already protected by existing `_resolve_and_validate_path`
2. **Filename Sanitization**: Implemented in `_get_safe_track_name`
3. **Resource Limits**: 5-minute timeout per conversion
4. **Rate Limiting**: Consider adding to prevent abuse

## Questions Answered

### Where to organize downloading?
**Answer**: New `download.py` blueprint, separate from `MixtapeManager`
- `MixtapeManager` = metadata only
- `download` blueprint = packaging & conversion

### How are files used when user revisits?
**Answer**: They aren't! The downloaded ZIP is completely standalone:
- User extracts ZIP to their device
- Opens `index.html` or uses media player
- No server connection needed
- Revisiting the web page generates a fresh download

This is intentional - offline means truly offline, not "cached in browser."
