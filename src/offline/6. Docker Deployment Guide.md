# Docker Deployment Guide for Download Feature

## ‚úÖ What You Already Have

Good news! Your Dockerfile already includes everything needed for the download feature:

```dockerfile
ffmpeg              # ‚úì Already installed (line 7)
libtag1-dev         # ‚úì Already installed (for music metadata)
gcc, libffi-dev     # ‚úì Already installed (for Python dependencies)
```

## üîß Changes Made

### 1. Dockerfile (Cleaned Up)
**Problem**: Your Dockerfile had duplicate content (lines 1-29 repeated as 30-56)

**Fixed**:
- Removed duplication
- Added `ffmpeg -version` check to verify installation
- All requirements already present

### 2. docker-compose.yml (Enhanced)
**Added**:
- Comments about optional resource limits
- Notes about data persistence

**Optional**: Uncomment resource limits if you want to prevent FFmpeg from using too much CPU during conversions

## üì¶ Dependencies Already Included

Your existing setup has:

| Requirement | Status | Purpose |
|------------|--------|---------|
| **ffmpeg** | ‚úÖ Installed | FLAC‚ÜíMP3 conversion |
| **Python 3.13** | ‚úÖ Installed | Base runtime |
| **libtag1-dev** | ‚úÖ Installed | Music file metadata reading |
| **gcc** | ‚úÖ Installed | Compile Python extensions |

## üöÄ Deployment Steps

### Step 1: Rebuild the Docker Image

```bash
cd /path/to/mixtape-society

# Rebuild with cleaned-up Dockerfile
docker build -t mixtape-society:latest .
```

### Step 2: Restart the Container

```bash
# Stop and remove old container
docker-compose down

# Start with new image
docker-compose up -d

# Check logs
docker-compose logs -f
```

### Step 3: Verify FFmpeg Works

```bash
# Enter the container
docker exec -it mixtape-society bash

# Test FFmpeg
ffmpeg -version

# Test a conversion (optional)
ffmpeg -i /music/some-song.flac -codec:a libmp3lame -b:a 320k -f mp3 - | head -c 100

# Exit
exit
```

## üéØ Testing the Download Feature

### 1. Stream M3U (Mobile)
```bash
# This should download a tiny M3U file
curl -O http://localhost:5000/download/your-mixtape-slug/playlist.m3u

# Check the content
cat your-mixtape-slug.m3u
```

### 2. Offline M3U (Mobile)
```bash
# Download offline M3U
curl -O http://localhost:5000/download/your-mixtape-slug/playlist-offline.m3u

# Check it points to track-file endpoints
cat your-mixtape-slug-offline.m3u
```

### 3. Single Track Conversion
```bash
# Test converting a FLAC to MP3
curl -o test.mp3 "http://localhost:5000/download/your-mixtape-slug/track/path/to/song.flac"

# Verify it's an MP3
file test.mp3
# Should output: test.mp3: Audio file with ID3 version 2.4.0
```

### 4. Complete ZIP Package
```bash
# Download full ZIP (this takes 1-2 minutes)
curl -O http://localhost:5000/download/your-mixtape-slug/package

# Extract and check contents
unzip your-mixtape-slug.zip -d test-mixtape
ls test-mixtape/
# Should show: index.html, mixtape.json, cover.jpg, and MP3 files
```

## üîç Troubleshooting

### Issue: "ffmpeg: not found"
**Solution**: Rebuild the Docker image
```bash
docker build --no-cache -t mixtape-society:latest .
```

### Issue: "Failed to convert FLAC"
**Check logs**:
```bash
docker-compose logs | grep -i ffmpeg
docker-compose logs | grep -i convert
```

**Common causes**:
1. FFmpeg not installed (rebuild image)
2. Invalid FLAC file (check source music file)
3. Out of memory (add resource limits in docker-compose)

### Issue: ZIP Download Takes Forever
**Expected**: 1-2 minutes for 12-track mixtape with FLACs

**If too slow**:
1. Check CPU usage: `docker stats mixtape-society`
2. Check container logs: `docker-compose logs -f`
3. Consider reducing quality in `download.py`:
   ```python
   "-b:a", "192k",  # Instead of "320k"
   ```

### Issue: High CPU Usage
**Solution**: Add resource limits to docker-compose.yml

```yaml
deploy:
  resources:
    limits:
      cpus: '2.0'      # Max 2 CPU cores
      memory: 2G       # Max 2GB RAM
```

### Issue: Container Crashes During Conversion
**Likely cause**: Out of memory

**Solution**:
1. Increase memory limit in docker-compose.yml
2. Or reduce FFmpeg threads in `download.py`:
   ```python
   cmd = [
       "ffmpeg",
       "-threads", "2",  # Limit to 2 threads
       "-i", str(flac_path),
       # ... rest of command
   ]
   ```

## üìä Performance Expectations

### Conversion Speed
- **Small FLAC** (~20MB): 5-10 seconds
- **Large FLAC** (~50MB): 15-30 seconds
- **12-track mixtape**: 2-6 minutes total

### Resource Usage
- **CPU**: 50-100% during conversion (1-2 cores)
- **Memory**: 200-500MB per conversion
- **Disk**: Temporary use only (in-memory ZIP creation)

### Network Impact
- **M3U files**: Instant (2KB)
- **Single MP3**: 7-10MB (streaming)
- **Complete ZIP**: 80-120MB (full download)

## üîí Security Considerations

### Path Traversal Protection
Already implemented in `_serve_track()`:
```python
# Verify track belongs to mixtape
track_found = False
for track in mixtape.get("tracks", []):
    if track.get("path") == track_path:
        track_found = True
        break

if not track_found:
    abort(404)  # Prevent accessing arbitrary files
```

### Resource Limits
Consider adding rate limiting:

```python
# In app.py
from flask_limiter import Limiter

limiter = Limiter(
    app,
    default_limits=["500 per day", "100 per hour"]
)

# In download.py
@download.route("/<slug>/package")
@limiter.limit("5 per hour")  # Max 5 ZIP downloads per hour
def download_mixtape(slug: str):
    ...

@download.route("/<slug>/track/<path:track_path>")
@limiter.limit("100 per hour")  # Max 100 track streams per hour
def download_track(slug: str, track_path: str):
    ...
```

## üìà Monitoring

### Check Conversion Success Rate
```bash
# Check logs for conversion failures
docker-compose logs | grep "Failed to convert" | wc -l

# Check successful conversions
docker-compose logs | grep "Saved mixtape" | wc -l
```

### Monitor Resource Usage
```bash
# Real-time stats
docker stats mixtape-society

# Disk usage
docker exec mixtape-society du -sh /app/collection-data
```

### Check FFmpeg Performance
```bash
# See FFmpeg logs in container
docker-compose logs -f | grep ffmpeg
```

## üéâ Everything is Ready!

Your Docker setup is **already configured** for the download feature:
- ‚úÖ FFmpeg installed
- ‚úÖ All dependencies present
- ‚úÖ Python environment ready
- ‚úÖ No additional configuration needed

Just:
1. Replace the old `download.py` with the new one
2. Update `play_mixtape.html` template
3. Update `downloadHelper.js`
4. Rebuild the image
5. Restart the container

**That's it!** The download feature will work immediately.

## üîó Related Files

Copy these updated files to your project:
- `src/routes/download.py` (new file)
- `src/templates/play_mixtape.html` (updated)
- `src/static/js/player/downloadHelper.js` (updated)
- `src/static/js/player/index.js` (updated)
- `src/routes/__init__.py` (add download blueprint import)
- `src/app.py` (register download blueprint)
