<!DOCTYPE html>
<html lang="nl" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Muziek Playlist Builder</title>

    <!-- Bootstrap 5.3 + icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <!-- Sortable.js voor drag & drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        body {
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        .track-title mark,
        .artist-name mark,
        .album-title mark {
            background-color: #ffeb3b;
            color: #000;
            padding: 0.1em 0.2em;
            border-radius: 0.2em;
        }
        .drag-handle {
            cursor: grab;
            opacity: 0.6;
        }
        .drag-handle:active { cursor: grabbing; }
        .playlist-ghost {
            opacity: 0.4;
            background: var(--bs-primary-bg-subtle);
            border: 2px dashed var(--bs-primary);
        }
        .btn-clear-playlist {
            width: 100%;
        }
        #searchInput {
            height: 58px;                    /* zorgt voor consistente hoogte */
            padding-left: 52px !important;   /* ruimte voor icoon links */
            padding-right: 52px !important;  /* ruimte voor spinner rechts */
        }

        /* Zorgt dat het icoon altijd netjes verticaal gecentreerd blijft */
        .bi-search {
            font-size: 1.25rem;
            pointer-events: none;
        }
    </style>
</head>
<body class="pb-5">

<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Muziek Playlist Maker</h1>

        <!-- Theme switcher -->
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="themeButton">
                <i class="bi bi-sun-fill" id="themeIcon"></i> <span id="themeText">Auto</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><button class="dropdown-item" data-theme="light"><i class="bi bi-sun-fill"></i> Licht</button></li>
                <li><button class="dropdown-item" data-theme="dark"><i class="bi bi-moon-stars-fill"></i> Donker</button></li>
                <li><button class="dropdown-item active" data-theme="auto"><i class="bi bi-circle-half"></i> Systeem</button></li>
            </ul>
        </div>
    </div>

    <!-- Zoekbalk -->
    <div class="row mb-4">
        <div class="col">
            <div class="position-relative">
                <input type="text" id="searchInput" class="form-control form-control-lg rounded-pill ps-5 pe-5"
                    placeholder="Zoek op artiest, album of nummer..." autocomplete="off">

                <!-- Vergrootglas links -->
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-4 text-muted"></i>

                <!-- Loading spinner rechts -->
                <div id="loading" class="position-absolute top-50 end-0 translate-middle-y me-4 visually-hidden">
                    <span class="spinner-border spinner-border-sm text-muted" role="status" aria-hidden="true"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Bibliotheek -->
        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-music-note-list"></i> Bibliotheek</h2>
                </div>
                <div class="card-body" id="results">
                    <p class="text-muted text-center my-5">Typ minimaal 2 tekens om te zoeken…</p>
                </div>
            </div>
        </div>

        <!-- Playlist -->
        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0"><i class="bi bi-list-ul"></i> Mijn Playlist <span id="playlist-count">(0)</span></h2>
                </div>
                <div class="card-body">
                    <ol id="playlist" class="list-unstyled mb-0"></ol>
                    <button id="clear-playlist" class="btn btn-danger mt-3 btn-clear-playlist">
                        <i class="bi bi-trash"></i> Playlist leegmaken
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/* ==== THEME HANDLING ==== */
(function () {
    const html = document.documentElement;
    const themeButton = document.getElementById('themeButton');
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');

    function setTheme(theme) {
        if (theme === 'auto') {
            html.setAttribute('data-bs-theme', window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            themeIcon.className = 'bi bi-circle-half';
            themeText.textContent = 'Systeem';
        } else {
            html.setAttribute('data-bs-theme', theme);
            themeIcon.className = theme === 'dark' ? 'bi bi-moon-stars-fill' : 'bi bi-sun-fill';
            themeText.textContent = theme === 'dark' ? 'Donker' : 'Licht';
        }
        localStorage.setItem('theme', theme);
        document.querySelectorAll('[data-theme]').forEach(el => el.classList.toggle('active', el.dataset.theme === theme));
    }

    // init
    const saved = localStorage.getItem('theme') || 'auto';
    setTheme(saved);

    // dropdown clicks
    document.querySelectorAll('[data-theme]').forEach(item => {
        item.addEventListener('click', () => setTheme(item.dataset.theme));
    });

    // luister naar systeemverandering
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (localStorage.getItem('theme') === 'auto' || !localStorage.getItem('theme')) {
            setTheme('auto');
        }
    });
})();

/* ==== ZOEKEN & RESULTATEN ==== */
const searchInput = document.getElementById('searchInput');
const resultsDiv = document.getElementById('results');
const playlistOl = document.getElementById('playlist');
const playlistCount = document.getElementById('playlist-count');
let playlist = [];

let timeout;
searchInput.addEventListener('input', () => {
    clearTimeout(timeout);
    document.getElementById('loading').classList.remove('visually-hidden');
    timeout = setTimeout(() => {
        const q = searchInput.value.trim();
        if (q.length < 2) {
            resultsDiv.innerHTML = '<p class="text-muted text-center my-5">Typ minimaal 2 tekens om te zoeken…</p>';
            document.getElementById('loading').classList.add('visually-hidden');
            return;
        }
        fetch(`/search?q=${encodeURIComponent(q)}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('loading').classList.add('visually-hidden');
                renderResults(data);
            });
    }, 300);
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function highlightText(text, query) {
    if (!query) return escapeHtml(text);
    const regex = new RegExp(`(${escapeHtml(query).replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return escapeHtml(text).replace(regex, '<mark>$1</mark>');
}

function renderResults(data) {
    if (data.length === 0) {
        resultsDiv.innerHTML = '<p class="text-center text-muted my-5">Geen resultaten gevonden.</p>';
        return;
    }

    resultsDiv.innerHTML = data.map(entry => {
        // badges met redenen
        const badges = entry.reasons.map(r => {
            const icons = { artist: 'bi-person-fill', album: 'bi-disc-fill', track: 'bi-music-note' };
            const colors = { artist: 'success', album: 'warning', track: 'primary' };
            return `<span class="badge bg-${colors[r.type]} me-1">
                        <i class="bi ${icons[r.type]}"></i> ${escapeHtml(r.text)}
                    </span>`;
        }).join('');

        const tracksHtml = entry.tracks.map(track => {
            const highlighted = entry.highlighted_tracks?.find(h => h.original.title === track.title);
            const title = highlighted ? highlighted.highlighted : track.title;

            return `
                <li class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span class="track-title flex-grow-1">${title}</span>
                    <span class="text-muted me-3">${track.duration}</span>
                    <button class="btn btn-success btn-sm add-btn"
                            data-artist="${escapeHtml(entry.artist)}"
                            data-album="${escapeHtml(entry.album)}"
                            data-title="${escapeHtml(track.title)}"
                            data-duration="${track.duration}">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </li>`;
        }).join('');

        return `
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h3 class="h4 artist-name mb-0">${highlightText(entry.artist, searchInput.value)}</h3>
                    <div>${badges}</div>
                </div>
                <h4 class="h5 album-title text-muted">${highlightText(entry.album, searchInput.value)}</h4>
                <ul class="list-unstyled mt-3">${tracksHtml}</ul>
            </div>`;
    }).join('');

    // add-to-playlist knoppen
    document.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const item = {
                artist: this.dataset.artist,
                album: this.dataset.album,
                title: this.dataset.title,
                duration: this.dataset.duration
            };
            addToPlaylist(item);
        });
    });
}

/* ==== PLAYLIST ==== */
function addToPlaylist(item) {
    if (playlist.some(t => t.artist === item.artist && t.album === item.album && t.title === item.title)) return;
    playlist.push(item);
    renderPlaylist();
}

function renderPlaylist() {
    playlistOl.innerHTML = playlist.map((item, idx) => `
        <li class="d-flex align-items-center rounded p-3 mb-2 shadow-sm playlist-item
           bg-body-tertiary border" data-index="${idx}">
            <div class="drag-handle me-3 text-muted">⋮⋮</div>
            <div class="flex-grow-1">
                <strong>${escapeHtml(item.title)}</strong><br>
                <small class="text-muted">${escapeHtml(item.artist)} • ${escapeHtml(item.album)}</small>
            </div>
            <span class="text-muted me-3">${item.duration}</span>
            <button class="btn btn-danger btn-sm remove-btn" data-index="${idx}">
                <i class="bi bi-x-lg"></i>
            </button>
        </li>
    `).join('');

    playlistCount.textContent = `(${playlist.length})`;

    // verwijderknoppen
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.onclick = () => {
            playlist.splice(btn.dataset.index, 1);
            renderPlaylist();
        };
    });
}

// Drag & drop
new Sortable(playlistOl, {
    animation: 150,
    ghostClass: 'playlist-ghost',
    handle: '.drag-handle',
    onEnd: evt => {
        const moved = playlist.splice(evt.oldIndex, 1)[0];
        playlist.splice(evt.newIndex, 0, moved);
        renderPlaylist();
    }
});

// Playlist leegmaken
document.getElementById('clear-playlist').addEventListener('click', () => {
    playlist = [];
    renderPlaylist();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>